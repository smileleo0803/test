
test/SME成效複驗2

/*補電商及專案日期*/

create multiset table temp_analysisdev.Z35615_loan_amt as  (
select base.* ,Account_Nbr ,Approval_Date, Application_Date ,Approval_Amt , Application_Amt ,Current_Bal, Acct_Status_Code
, case when project_name = 'SCC_5371' and Approval_Date >= then 1
    when projectproject_name = 'SCC_4040' and Approval_Date >=  then 1
    when project_name = 'SCC_2470' and Approval_Date >=  then 1
    when project_name = 'ECC_105' and Approval_Date >= then 1
    when _name = 'ECC_119' and Approval_Date >=  then 1
    when project_name = 'SCC_7000' and Approval_Date >= then 1
    when project_name = 'SCC_7000' and Approval_Date >= then 1
    else 0 end as date_flag
from temp_analysisdev.Z35615_base_cnt as base
left join 
(
(select customer_id ,  Account_Nbr , max(Approval_Date) as Approval_Date  
 from vp_bns_mcif.bns_loan
 where Approval_Date - Application_Date >= 0
 and Acct_Status_Code not in ('40') --排除結清
 and Bad_Debit_Code in ('00','30','40','90') --帳戶正常狀態
 group by customer_id ,  Account_Nbr )
union 
(select customer_id ,  Account_Nbr , max(Approval_Date) as Approval_Date
 from vc_bns_mcif.bns_loan
 where Approval_Date - Application_Date >= 0
 and Acct_Status_Code not in ('40') --排除結清
 and Bad_Debit_Code in ('00','30','40','90') --帳戶正常狀態
 group by customer_id ,  Account_Nbr ) 
 ) apvd 
 on base.sme_id = apvd.customer_id

left join (
 (select customer_id ,  Account_Nbr ,Approval_Date, Application_Date ,Approval_Amt , Application_Amt ,Current_Bal, Acct_Status_Code
 from vp_bns_mcif.bns_loan 
 where Acct_Status_Code not in ('40') 
 and Bad_Debit_Code in ('00','30','40','90') )
 union 
 (select customer_id ,  Account_Nbr ,Approval_Date, Application_Date ,Approval_Amt , Application_Amt ,Current_Bal, Acct_Status_Code
 from vc_bns_mcif.bns_loan 
 where Acct_Status_Code not in ('40') and Bad_Debit_Code in ('00','30','40','90') ) 
 ) a
 on apvd.customer_id = a.customer_id and apvd.Account_Nbr = a.Account_Nbr and apvd.Approval_Date = a.Approval_Date
 ) with data ; 


/*符合期間條件之餘額*/
select a.* ,T_Approval_Amt , T_Application_Amt , T_Current_Bal
from temp_analysisdev.Z35615_base_cnt as a
left join (
select project_name ,sme_id ,sum(Approval_Amt) as T_Approval_Amt , sum(Application_Amt) as T_Application_Amt ,sum(Current_Bal) as T_Current_Bal
from temp_analysisdev.Z35615_loan_amt
where date_flag = 1
group by project_name ,sme_id
) as b
on a.project_name = b. project_name and a.sme_id = b.sme_id



